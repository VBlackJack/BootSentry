<UserControl x:Class="BootSentry.UI.Views.SnapshotManagerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:BootSentry.UI.Views"
             xmlns:vm="clr-namespace:BootSentry.UI.ViewModels"
             xmlns:res="clr-namespace:BootSentry.UI.Resources"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">
    <Grid Background="{DynamicResource PanelBackground}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar: Snapshots List -->
        <Border Grid.Column="0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,1,0">
            <Grid Margin="12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="{res:Localize SnapshotSidebarTitle}" Style="{StaticResource SectionHeader}" Margin="0,0,0,12"/>

                <ListBox Grid.Row="1" ItemsSource="{Binding Snapshots}" SelectedItem="{Binding SelectedSnapshot}"
                         Background="Transparent" BorderThickness="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border CornerRadius="4" Margin="0,2">
                                <Grid Margin="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding CreatedAt, StringFormat=g}" FontSize="11" Foreground="{DynamicResource MutedForeground}"/>
                                    </StackPanel>
                                    <Button Command="{Binding DataContext.DeleteSnapshotCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Background="Transparent" BorderThickness="0"
                                            ToolTip="{res:Localize SnapshotDeleteTooltip}">
                                        <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets" Foreground="{DynamicResource DangerBrush}"/>
                                    </Button>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <Button Grid.Row="2" Command="{Binding CreateSnapshotCommand}" Content="{res:Localize SnapshotCreate}" Margin="0,12,0,0"/>
            </Grid>
        </Border>

        <!-- Main Area: Details or Comparison -->
        <Grid Grid.Column="1" Margin="20">
            <!-- No Selection State -->
            <StackPanel Visibility="{Binding SelectedSnapshot, Converter={StaticResource NullToVisibility}}"
                        HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="{res:Localize SnapshotSelectHint}" Foreground="{DynamicResource MutedForeground}"/>
            </StackPanel>

            <!-- Loading State -->
            <StackPanel Visibility="{Binding IsComparing, Converter={StaticResource BoolToVisibility}}"
                        HorizontalAlignment="Center" VerticalAlignment="Center" Panel.ZIndex="10">
                <ProgressBar IsIndeterminate="True" Width="150" Height="4" Margin="0,0,0,12"/>
                <TextBlock Text="{res:Localize SnapshotComparing}" Foreground="{DynamicResource MutedForeground}"/>
            </StackPanel>

            <!-- Selected Snapshot Details -->
            <Grid Visibility="{Binding SelectedSnapshot, Converter={StaticResource NotNullToVisibility}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="0,0,0,20">
                    <TextBlock Text="{Binding SelectedSnapshot.Name}" FontSize="24" FontWeight="Bold"/>
                    <TextBlock Text="{Binding SelectedSnapshot.CreatedAt, StringFormat='Created on {0:F}'}" Foreground="{DynamicResource MutedForeground}"/>
                    <TextBlock Text="{Binding SelectedSnapshot.Description}" Margin="0,8,0,0" TextWrapping="Wrap"/>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,20">
                    <Button Command="{Binding CompareWithCurrentCommand}" Content="{res:Localize SnapshotCompareWithCurrent}"
                            IsEnabled="{Binding IsComparing, Converter={StaticResource InverseBool}}"/>
                </StackPanel>

                <!-- Comparison Result -->
                <ScrollViewer Grid.Row="2" Visibility="{Binding ComparisonResult, Converter={StaticResource NotNullToVisibility}}">
                    <StackPanel>
                        <TextBlock Text="{res:Localize SnapshotComparisonTitle}" Style="{StaticResource SectionHeader}"/>

                        <!-- Changes Summary -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                            <Border Background="{DynamicResource SuccessSoftBrush}" CornerRadius="4" Margin="0,0,8,0">
                                <TextBlock Text="{Binding ComparisonResult.AddedEntries.Count, StringFormat='Added: {0}'}" Foreground="{DynamicResource SuccessBrush}" FontWeight="Bold" Margin="8,4"/>
                            </Border>
                            <Border Background="{DynamicResource ErrorSoftBrush}" CornerRadius="4" Margin="0,0,8,0">
                                <TextBlock Text="{Binding ComparisonResult.RemovedEntries.Count, StringFormat='Removed: {0}'}" Foreground="{DynamicResource DangerBrush}" FontWeight="Bold" Margin="8,4"/>
                            </Border>
                            <Border Background="{DynamicResource WarningSoftBrush}" CornerRadius="4">
                                <TextBlock Text="{Binding ComparisonResult.ModifiedEntries.Count, StringFormat='Modified: {0}'}" Foreground="{DynamicResource WarningBrush}" FontWeight="Bold" Margin="8,4"/>
                            </Border>
                        </StackPanel>

                        <!-- Added Entries -->
                        <Expander Header="{res:Localize SnapshotAddedEntries}" IsExpanded="True"
                                  Visibility="{Binding ComparisonResult.AddedEntries.Count, Converter={StaticResource NotZeroToVisibility}}">
                            <ItemsControl ItemsSource="{Binding ComparisonResult.AddedEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource SuccessSoftBrush}" Margin="0,2" CornerRadius="4">
                                            <Grid Margin="8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="&#xE710;" FontFamily="Segoe MDL2 Assets" Foreground="{DynamicResource SuccessBrush}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding CommandLineRaw}" FontSize="11" TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Expander>

                        <!-- Removed Entries -->
                        <Expander Header="{res:Localize SnapshotRemovedEntries}" IsExpanded="True" Margin="0,8,0,0"
                                  Visibility="{Binding ComparisonResult.RemovedEntries.Count, Converter={StaticResource NotZeroToVisibility}}">
                            <ItemsControl ItemsSource="{Binding ComparisonResult.RemovedEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource ErrorSoftBrush}" Margin="0,2" CornerRadius="4">
                                            <Grid Margin="8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="&#xE738;" FontFamily="Segoe MDL2 Assets" Foreground="{DynamicResource DangerBrush}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding CommandLineRaw}" FontSize="11" TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Expander>

                        <!-- Modified Entries -->
                        <Expander Header="{res:Localize SnapshotModifiedEntries}" IsExpanded="True" Margin="0,8,0,0"
                                  Visibility="{Binding ComparisonResult.ModifiedEntries.Count, Converter={StaticResource NotZeroToVisibility}}">
                            <ItemsControl ItemsSource="{Binding ComparisonResult.ModifiedEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource WarningSoftBrush}" Margin="0,2" CornerRadius="4">
                                            <Grid Margin="8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="&#xE70F;" FontFamily="Segoe MDL2 Assets" Foreground="{DynamicResource WarningBrush}" Margin="0,0,8,0" VerticalAlignment="Top"/>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding TargetEntry.DisplayName}" FontWeight="SemiBold"/>
                                                    <ItemsControl ItemsSource="{Binding ChangedProperties}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Text="{Binding}" FontSize="11" Foreground="{DynamicResource MutedForeground}"/>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Expander>

                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
